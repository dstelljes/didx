<%

const title = `Index of ${[...parents.map(c => c.name), name].join('/')}`

function formatDate (date) {
  const ymd = `${pad(date.getUTCFullYear(), 4)}-${pad(date.getUTCMonth(), 2)}-${pad(date.getUTCDate(), 2)}`
  const hms = `${pad(date.getUTCHours(), 2)}:${pad(date.getUTCMinutes(), 2)}:${pad(date.getUTCSeconds(), 2)}`

  return `${ymd} ${hms}`
}

function formatName (item) {
  return item.type === 'directory'
    ? `${item.name}/`
    : item.name
}

function formatSize (bytes) {
  if (bytes == 0) {
    return '-'
  }

  const units = ['', 'K', 'M', 'G', 'T', 'P', 'E', 'Z', 'Y']

  const base = 1024
  const magnitude = Math.floor(Math.log(bytes) / Math.log(base))

  return `${parseFloat((bytes / Math.pow(base, magnitude)).toFixed(1))}${units[magnitude]}`
}

function pad (number, digits) {
  const string = Math.abs(number).toString()

  if (string.match(/[^0-9]/) || string.length >= digits) {
    return number.toString()
  }

  const sign = number < 0 ? '-' : ''
  const padding = new Array(digits - string.length).fill('0').join('')

  return `${sign}${padding}${string}`
}

%>

<!DOCTYPE html>

<html dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title><%= title %></title>
  </head>

  <body>
    <h1><%= title %></h1>

    <table>
      <tr>
        <th>Name</th>
        <th>Last modified</th>
        <th>Size</th>
        <th>Description</th>
      </tr>

      <tr>
        <th colspan="5"><hr></th>
      </tr>

      <% if (parents.length > 0) { %>
        <tr>
          <td><a href="../">Parent directory</a></td>
        </tr>
      <% } %>

      <% for (const item of items) { %>
        <tr>
          <td><a href="<%= formatName(item) %>"><%= formatName(item) %></a></td>
          <td><%= formatDate(item.modified) %></td>
          <td align="right"><%= formatSize(item.size) %></td>
          <td></td>
        </tr>
      <% } %>

      <tr>
        <th colspan="5"><hr></th>
      </tr>
    </table>

    <address>
      Generated by <a href="https://github.com/dstelljes/didx">didx</a> at <%= formatDate(timestamp) %>.
    </address>
  </body>
</html>
